name: Comprehensive Security SSDLC

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # STAGE 1: CODE QUALITY (The "SonarQube-Lite" Stage)
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.9"
    - name: Install Linting Tools
      run: pip install flake8
    - name: Run Flake8 (Code Smells)
      # E501 ignores long lines, F401 ignores unused imports
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

  # STAGE 2: STATIC APPLICATION SECURITY TESTING (SAST)
  sast-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.9"
    - name: Install Security Tools
      run: |
        pip install bandit pbr
    - name: Run Bandit (Security Scan)
      # -r recursive, -ll medium/high severity only
      run: bandit -r server.py -ll

  # STAGE 3: SUPPLY CHAIN SECURITY (SCA)
  dependency-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.9"
    - name: Install Safety
      run: pip install safety
    - name: Install Project Dependencies
      run: pip install -r requirements.txt
    - name: Run Safety Check (Known Vulnerabilities)
      # Checks if Flask/Cryptography versions have known CVEs
      run: safety check -r requirements.txt --continue-on-error

  # STAGE 4: FUNCTIONAL & ROBUSTNESS TESTING
  unit-tests:
    runs-on: ubuntu-latest
    needs: [quality-check, sast-scan, dependency-scan] # Wait for checks to pass
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.9"
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    - name: Run Unit & Negative Tests
      run: python -m unittest test_crypto.py
